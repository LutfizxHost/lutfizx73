<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracker — Daftar Klik & Kontrol (Demo Lokal)</title>
  <style>
    :root{
      --bg:#071033; --panel:#071427; --accent:#06b6d4; --muted:rgba(255,255,255,0.07);
      --text:#e6eef8;
      --glass: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,var(--bg),#021028);
      color:var(--text);
      min-height:100vh;
      padding:28px;
    }
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px}
    button, a.btn{
      background:linear-gradient(90deg,var(--accent),#0ea5a4);
      border:0;
      padding:10px 12px;
      color:white;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
    }
    .muted{background:transparent;border:1px solid var(--muted);color:var(--text)}
    .notice{background:linear-gradient(90deg,var(--glass),rgba(255,255,255,0.01));border-radius:10px;padding:12px;border:1px solid var(--muted);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px;align-items:start}
    .panel{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.01));border-radius:12px;padding:14px;border:1px solid var(--muted)}
    .log-list{max-height:520px;overflow:auto;padding:6px}
    .entry{display:flex;justify-content:space-between;gap:12px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01);margin-bottom:8px;font-size:13px;align-items:center}
    .meta{color:rgba(230,238,248,0.7);font-size:12px}
    .summary{display:flex;gap:10px;align-items:center}
    .count{font-weight:700;font-size:18px}
    .btn-small{padding:6px 10px;border-radius:8px;font-size:13px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)}
    footer{margin-top:18px;color:rgba(230,238,248,0.6);font-size:13px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:40}
    .modal{width:100%;max-width:420px;background:linear-gradient(180deg,var(--panel),#06121e);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.8)}
    .modal h3{margin:0 0 8px 0;font-size:16px}
    .field{margin:8px 0;font-size:13px}
    .note{font-size:12px;color:rgba(230,238,248,0.65)}
    .status{font-size:13px;margin-top:10px;color:rgba(230,238,248,0.85)}

    code{background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.02)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tracker — Daftar Klik & Kontrol (Demo Lokal)</h1>
      <div class="controls">
        <button id="recordBtn">Klik untuk Merekam Klik</button>
        <button id="clearBtn" class="muted">Hapus Riwayat</button>
        <button id="exportBtn" class="muted">Ekspor CSV</button>
      </div>
    </header>

    <div class="notice panel">
      <strong>Catatan Privasi & Batasan Teknis</strong>
      <p style="margin:6px 0 0 0">Panel kontrol (mis. tombol senter) hanya dapat memengaruhi perangkat yang sedang membuka halaman ini dan memberikan izin kamera. Halaman ini tidak melakukan kontrol jarak jauh ke perangkat lain. Gunakan fitur ini hanya pada perangkat milikmu atau setelah meminta izin eksplisit dari pemilik perangkat.</p>
    </div>

    <div class="grid">
      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <div style="font-size:13px;color:rgba(230,238,248,0.8)">Ringkasan</div>
            <div class="summary">
              <div class="count" id="totalCount">0</div>
              <div style="font-size:13px;color:rgba(230,238,248,0.6)">klik tercatat</div>
            </div>
          </div>
          <div style="text-align:right;color:rgba(230,238,248,0.6);font-size:12px" id="lastTime">—</div>
        </div>

        <div class="log-list" id="logList" aria-live="polite">
          <!-- entri muncul di sini -->
        </div>
      </section>

      <aside class="panel">
        <h3 style="margin:0 0 10px 0;font-size:15px">Deteksi Perangkat Saat Ini</h3>
        <div id="currentInfo" style="font-size:13px;color:rgba(230,238,248,0.9);line-height:1.5">
          Memuat...
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <div>
          <strong>Fungsi</strong>
          <ul style="margin:8px 0 0 18px;color:rgba(230,238,248,0.85);font-size:13px">
            <li>Rekam klik saat tombol ditekan</li>
            <li>Setiap entri memiliki tombol <code>Masuk</code> untuk membuka panel kontrol lokal</li>
            <li>Panel kontrol dapat menyalakan senter jika perangkat mendukung</li>
          </ul>
        </div>

        <footer>
          <p style="margin-top:12px">Akurasi deteksi model bergantung pada user agent. Fitur senter bekerja terutama pada Chrome Android modern yang mendukung capability <code>torch</code> pada track kamera belakang.</p>
        </footer>
      </aside>
    </div>

  </div>

  <!-- Modal kontrol -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Kontrol Perangkat</h3>
      <div class="field"><strong>Target:</strong> <span id="targetInfo">—</span></div>
      <div class="field note" id="controlNote">Jika halaman ini dibuka pada perangkat target dan izin diberikan, Anda dapat menyalakan senter dari sini. Jika tidak, kontrol tidak akan berfungsi.</div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="toggleTorchBtn" class="btn btn-small">Aktifkan Senter</button>
        <button id="closeModalBtn" class="btn btn-small btn-ghost">Tutup</button>
      </div>

      <div class="status" id="controlStatus">Status: menunggu tindakan</div>
    </div>
  </div>

  <script>
    // Utilities
    function nowISO(){return new Date().toISOString()}
    function safeText(s){return String(s ?? '').replace(/[<>]/g,'')}
    const STORAGE_KEY = 'click_tracker_log_v1';

    // Device detection (best-effort)
    function parseDeviceInfo(){
      const ua = navigator.userAgent || '';
      const uaData = navigator.userAgentData || null;
      let brand = 'Unknown'; let model = 'Unknown'; let os = 'Unknown';

      if(uaData && typeof uaData.getHighEntropyValues === 'function'){
        if(Array.isArray(uaData.brands) && uaData.brands.length){
          brand = uaData.brands.map(b => b.brand).join('/');
        }
        if(typeof uaData.mobile === 'boolean'){
          os = uaData.mobile ? 'Mobile' : 'Desktop';
        }
      }

      const androidMatch = ua.match(/Android\s+([\d.]+)/i);
      const iosMatch = ua.match(/OS\s([\d_]+)\slike Mac OS X/i) || ua.match(/CPU (?:iPhone )?OS\s([\d_]+)/i);
      if(androidMatch) os = 'Android ' + androidMatch[1];
      else if(iosMatch) os = 'iOS ' + iosMatch[1].replace(/_/g,'.');
      else {
        if(/Windows NT/i.test(ua)) os = 'Windows';
        else if(/Mac OS X/i.test(ua) && !/iPhone|iPad|iPod/i.test(ua)) os = 'macOS';
        else if(/Linux/i.test(ua)) os = 'Linux';
      }

      const inside = (ua.match(/\(([^)]+)\)/) || [null, ''])[1];
      if(inside){
        const parts = inside.split(';').map(p => p.trim()).filter(Boolean);
        for(const p of parts){
          if(/Android|Windows NT|Linux|Mac OS X|CPU|Apple/i.test(p)) continue;
          if(/\b(iPhone|Pixel|SM-|GT-|Redmi|Mi|HUAWEI|HONOR|Vivo|OPPO|OnePlus|RM|M200|Xiaomi|POCO|Infinix|TECNO)\b/i.test(p) || /[A-Z]{2,}-\d+/i.test(p) || /\d/.test(p)){
            model = p; break;
          }
        }
        if(model === 'Unknown' && parts.length) model = parts[parts.length-1];
      }

      if(/iPhone|iPad|iPod/i.test(ua)) brand = 'Apple';
      else if(/Pixel/i.test(ua)) brand = 'Google';
      else if(/Samsung|SM-/i.test(ua)) brand = 'Samsung';
      else if(/Xiaomi|Mi |Redmi|M200|M201/i.test(ua)) brand = 'Xiaomi/Redmi';
      else if(/HUAWEI|HONOR/i.test(ua)) brand = 'Huawei/Honor';
      else if(/OnePlus/i.test(ua)) brand = 'OnePlus';
      else if(/OPPO|Realme/i.test(ua)) brand = 'OPPO/Realme';
      else if(/Vivo/i.test(ua)) brand = 'Vivo';

      brand = safeText(brand); model = safeText(model); os = safeText(os);
      return { brand, model, os, uaSnippet: ua.slice(0,220) };
    }

    // Storage
    function loadLog(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return []; const parsed = JSON.parse(raw); return Array.isArray(parsed) ? parsed : []; }catch(e){console.error(e); return []}}
    function saveLog(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch(e){console.error(e)}}

    // Render
    function formatEntry(e, idx){
      // include Masuk button
      return `
        <div class="entry" data-idx="${idx}">
          <div style="flex:1;min-width:0">
            <div><strong>${safeText(e.brand)}</strong> — ${safeText(e.model)}</div>
            <div class="meta">${safeText(e.os)} · ${safeText(e.time)}</div>
            <div class="meta" style="margin-top:6px;font-size:11px">UA: ${safeText(e.uaSnippet)}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <button class="btn btn-small btn-ghost openControlBtn" data-idx="${idx}">Masuk</button>
          </div>
        </div>
      `;
    }

    function renderList(){
      const list = loadLog();
      const container = document.getElementById('logList');
      container.innerHTML = list.map((e, i) => formatEntry(e, i)).join('');
      document.getElementById('totalCount').textContent = String(list.length);
      document.getElementById('lastTime').textContent = list.length ? list[list.length-1].time : '—';

      // attach events to Masuk buttons
      Array.from(container.querySelectorAll('.openControlBtn')).forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          const idx = Number(btn.getAttribute('data-idx'));
          openControlForIndex(idx);
        });
      });
    }

    // Actions: record, clear, export
    function recordClick(){
      const info = parseDeviceInfo();
      const entry = { time: (new Date()).toLocaleString(), brand: info.brand, model: info.model, os: info.os, uaSnippet: info.uaSnippet };
      const log = loadLog(); log.push(entry); saveLog(log); renderList();
    }

    function clearLog(){
      if(!confirm('Hapus semua riwayat lokal? Tindakan ini tidak bisa dibatalkan.')) return;
      localStorage.removeItem(STORAGE_KEY);
      renderList();
    }

    function exportCSV(){
      const log = loadLog();
      if(!log.length){ alert('Tidak ada data untuk diekspor.'); return; }
      const header = ['time','brand','model','os','uaSnippet'];
      const rows = [header.join(',')].concat(log.map(r => [r.time, r.brand, r.model, r.os, r.uaSnippet].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')));
      const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'tracker_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Modal & Control logic
    const modalBackdrop = document.getElementById('modalBackdrop');
    const targetInfoEl = document.getElementById('targetInfo');
    const controlStatusEl = document.getElementById('controlStatus');
    const toggleTorchBtn = document.getElementById('toggleTorchBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let currentControlIndex = null;
    let currentStream = null;
    let currentTrack = null;
    let torchOn = false;

    function openControlForIndex(idx){
      const log = loadLog();
      if(idx < 0 || idx >= log.length) return;
      const entry = log[idx];
      currentControlIndex = idx;
      // show basic target info
      targetInfoEl.textContent = `${entry.brand} — ${entry.model} (${entry.os}) · ${entry.time}`;
      controlStatusEl.textContent = 'Status: menunggu tindakan';
      // show hint if UA mismatch
      const cur = parseDeviceInfo();
      if(entry.uaSnippet && cur.uaSnippet && entry.uaSnippet.slice(0,60) !== cur.uaSnippet.slice(0,60)){
        document.getElementById('controlNote').textContent = 'Catatan: user agent target berbeda dari perangkat Anda sekarang. Kontrol senter hanya akan bekerja jika modal ini dijalankan pada perangkat target (mereka harus membuka halaman ini sendiri).';
      } else {
        document.getElementById('controlNote').textContent = 'Jika halaman ini dibuka pada perangkat target dan Anda memberikan izin, tombol senter akan berfungsi pada perangkat tersebut.';
      }
      // open modal
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
    }

    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      controlStatusEl.textContent = 'Status: menunggu tindakan';
      // cleanup camera stream if still open
      stopCameraStream();
    }

    async function startCameraStreamForTorch(){
      // request video with environment facing mode
      try {
        if(currentStream) return currentStream;
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } });
        const track = stream.getVideoTracks()[0];
        currentStream = stream;
        currentTrack = track;
        return stream;
      } catch (err){
        console.error('getUserMedia error', err);
        throw err;
      }
    }

    function stopCameraStream(){
      try {
        if(currentTrack){
          try{ currentTrack.stop(); }catch(e){}
          currentTrack = null;
        }
        if(currentStream){
          try{ currentStream.getTracks().forEach(t=>t.stop()); }catch(e){}
          currentStream = null;
        }
        torchOn = false;
      } catch(e){ console.error(e) }
    }

    async function toggleTorch(){
      controlStatusEl.textContent = 'Status: memeriksa perangkat...';
      try {
        // start stream
        await startCameraStreamForTorch();
        if(!currentTrack){
          controlStatusEl.textContent = 'Status: tidak ada track kamera.';
          return;
        }
        const capabilities = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
        if(!capabilities.torch){
          controlStatusEl.textContent = 'Status: perangkat tidak mendukung torch via browser.';
          return;
        }
        // toggle
        torchOn = !torchOn;
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        controlStatusEl.textContent = torchOn ? 'Status: senter menyala' : 'Status: senter mati';
        toggleTorchBtn.textContent = torchOn ? 'Matikan Senter' : 'Aktifkan Senter';
      } catch (err){
        console.error('Torch toggle error', err);
        controlStatusEl.textContent = 'Status: gagal mengakses/menyetel senter — periksa izin kamera atau dukungan perangkat.';
      }
    }

    // event binding
    document.getElementById('recordBtn').addEventListener('click', recordClick);
    document.getElementById('clearBtn').addEventListener('click', clearLog);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    closeModalBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', function(e){
      if(e.target === modalBackdrop) closeModal();
    });
    toggleTorchBtn.addEventListener('click', toggleTorch);

    // Startup render
    renderList();
    (function showCurrentInfo(){
      const info = parseDeviceInfo();
      const el = document.getElementById('currentInfo');
      el.innerHTML = `<div><strong>Brand:</strong> ${info.brand}</div><div><strong>Model:</strong> ${info.model}</div><div><strong>OS:</strong> ${info.os}</div><div style="margin-top:8px;font-size:12px;color:rgba(230,238,248,0.7)"><strong>UserAgent (potong):</strong> ${info.uaSnippet}</div>`;
    })();

    // If userAgentData available, try to enrich info asynchronously
    if(navigator.userAgentData && typeof navigator.userAgentData.getHighEntropyValues === 'function'){
      navigator.userAgentData.getHighEntropyValues(['platform','model','uaFullVersion','fullVersionList'])
        .then(high=>{
          if(high.model){
            const el = document.getElementById('currentInfo');
            const cur = parseDeviceInfo();
            cur.model = high.model || cur.model;
            cur.brand = cur.brand === 'Unknown' ? (high.platform || cur.brand) : cur.brand;
            cur.os = high.platform ? high.platform + (high.uaFullVersion ? ' ' + high.uaFullVersion : '') : cur.os;
            el.innerHTML = `<div><strong>Brand:</strong> ${cur.brand}</div><div><strong>Model:</strong> ${cur.model}</div><div><strong>OS:</strong> ${cur.os}</div><div style="margin-top:8px;font-size:12px;color:rgba(230,238,248,0.7)"><strong>UserAgent (potong):</strong> ${cur.uaSnippet}</div>`;
          }
        }).catch(()=>{/* ignore */});
    }
  </script>
</body>
</html>